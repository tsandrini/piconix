// ---------------------------------------------------------------------
// Main rules
// ---------------------------------------------------------------------
source = { SOI ~ WHITESPACE* ~ nix_expression ~ WHITESPACE* ~ EOI }
// binding = { identifier ~ WHITESPACE* ~ "=" ~ WHITESPACE* ~ nix_expression ~ WHITESPACE* ~ ";" }

identifier_simple = @{ (ASCII_ALPHA | "_") ~ (ASCII_ALPHANUMERIC | "_" | "-")* }
identifier_part   = { identifier_simple | string }
identifier        = { identifier_part ~ ("." ~ identifier_part)* }
binding           = { identifier ~ "=" ~ nix_expression ~ ";" }

// ---------------------------------------------------------------------
// Terms - The building blocks of an expression.
// ---------------------------------------------------------------------
nix_expression = {
    list |
    attrset |
    string |
    null |
    boolean |
    float |
    path |
    search_path |
    integer |
    identifier
}

// ---------------------------------------------------------------------
// Complex Types
// ---------------------------------------------------------------------
list    = { "[" ~ (WHITESPACE* ~ nix_expression ~ WHITESPACE*)* ~ "]" }
attrset = { "{" ~ (WHITESPACE* ~ binding ~ WHITESPACE*)* ~ "}" }

// ---------------------------------------------------------------------
// Literals & Identifiers
// ---------------------------------------------------------------------
integer         = @{ ("-")? ~ ASCII_DIGIT+ }
float           = @{ ("-")? ~ ASCII_DIGIT+ ~ "." ~ ASCII_DIGIT+ }
boolean         = @{ "true" | "false" }
null            = @{ "null" }
search_path     = { "<" ~ identifier_simple ~ ">" } // e.g. <nixpkgs>
path = @{
    // Part 1: Handles paths starting with known prefixes: ~/ ../ ./ /
    ( "~/" | "../" | "./" | "/" ) ~ ( ( !( WHITESPACE | ";" ) ~ ANY )* ) |
    // Part 2: Handles paths like `foo/bar` that start with an identifier.
    identifier_simple ~ ( "/" ~ ( !( WHITESPACE | ";" ) ~ ANY )* )+
}

// ---------------------------------------------------------------------
// String literal + escaping
// ---------------------------------------------------------------------
string                = { "\"" ~ string_content* ~ "\"" }
interpolation         = { "${" ~ nix_expression ~ "}" }
escaped_quote         = @{ "\\" ~ "\"" }
escaped_interpolation = @{ "''${" }
string_literal_part   = @{ ( !("\"" | "$" | "\\" | "'") ~ ANY )+ }
dollar_literal        = @{ "$" ~ !("{") }
single_quote_literal  = @{ "'" ~ !"'" }
string_content = {
    escaped_quote |
    escaped_interpolation |
    interpolation |
    string_literal_part |
    dollar_literal |
    single_quote_literal
}

// ---------------------------------------------------------------------
// Whitespace and comments
// ---------------------------------------------------------------------
COMMENT    = _{ "#" ~ (!NEWLINE ~ ANY)* }
WHITESPACE = _{ " " | "\t" | NEWLINE }
